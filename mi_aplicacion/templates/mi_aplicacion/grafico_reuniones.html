{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">游늵 Estado de las Actividades</h2>

    <!-- Filtros -->
    <form method="get" action="{% url 'mi_aplicacion:grafico_reuniones' %}" class="row g-3 mb-4">
        <div class="col-md-4">
            <label for="proyecto" class="form-label">Proyecto</label>
            <select name="proyecto" id="proyecto" class="form-select">
                <option value="">Todos</option>
                {% for p in proyectos %}
                    <option value="{{ p.id }}" {% if proyecto_seleccionado == p.id|stringformat:"s" %}selected{% endif %}>
                        {{ p.nombre }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <!-- <div class="col-md-4">
            <label for="frente" class="form-label">Frente</label>
            <select name="frente" id="frente" class="form-select">
                <option value="">Todos</option>
                {% for f in frentes %}
                    <option value="{{ f.id }}" {% if frente_seleccionado == f.id|stringformat:"s" %}selected{% endif %}>
                        {{ f.nombre }}
                    </option>
                {% endfor %}
            </select>
        </div> -->

        <div class="col-md-3 d-flex align-items-end">
            <button type="submit" class="btn btn-success w-100">游댌 Filtrar</button>
        </div>
    </form>

    <!-- Bot칩n exportar -->
    <div class="mb-3">
        <button class="btn btn-primary" id="exportarImagen">游닌 Exportar todas las gr치ficas</button>
    </div>

    <!-- Gr치ficas -->
    <div class="row g-4">
        <div class="col-md-6">
            <div class="card shadow-sm p-3">
                <h6 class="mb-3">Distribuci칩n por estado</h6>
                <canvas id="chartPie" height="180"></canvas>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm p-3">
                <h6 class="mb-3">Vencimiento (activas / vencidas / sin fecha)</h6>
                <canvas id="chartVencimiento" height="180"></canvas>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm p-3">
                <h6 class="mb-3">Conteo por estado (barra)</h6>
                <canvas id="chartBar" height="160"></canvas>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm p-3">
                <h6 class="mb-3">Evoluci칩n / L칤nea</h6>
                <canvas id="chartLine" height="160"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js + plugin datalabels -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // Datos enviados desde el contexto
    const estados = {{ estados|default:"[]"|safe }};
    const cantidades = {{ cantidades|default:"[]"|safe }};

    const vencidoLabels = {{ vencido_labels|default:"[]"|safe }};
    const vencidoCounts = {{ vencido_counts|default:"[]"|safe }};

    // Si no hay datos para chartPie, evitamos errores
    const totalEstados = cantidades.reduce((a,b)=>a+b,0);
    const totalVenc = vencidoCounts.reduce((a,b)=>a+b,0);

    const colores = ['rgba(40,167,69,0.8)','rgba(255,193,7,0.85)','rgba(220,53,69,0.85)'];
    const bordes  = ['rgba(40,167,69,1)','rgba(255,193,7,1)','rgba(220,53,69,1)'];

    // Helper: crear opciones comunes para datalabels (porcentaje)
    function datalabelsPctOptions(total, txtColor='#fff'){
        return {
            plugins: {
                datalabels: {
                    formatter: (value) => {
                        if (!total || total === 0) return '0%';
                        return ((value / total) * 100).toFixed(1) + '%';
                    },
                    color: txtColor,
                    font: { weight: '600' }
                }
            }
        };
    }

    // PIE: por estado
    if (estados.length && cantidades.length) {
        new Chart(document.getElementById('chartPie'), {
            type: 'pie',
            data: {
                labels: estados,
                datasets: [{ data: cantidades, backgroundColor: colores, borderColor: bordes, borderWidth: 1 }]
            },
            options: Object.assign({
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }, datalabelsPctOptions(totalEstados, '#fff')),
            plugins: [ChartDataLabels]
        });
    }

    // VENCIMIENTO: activas / vencidas / sin fecha (pie)
    if (vencidoLabels.length && vencidoCounts.length) {
        new Chart(document.getElementById('chartVencimiento'), {
            type: 'pie',
            data: {
                labels: vencidoLabels,
                datasets: [{
                    data: vencidoCounts,
                    backgroundColor: ['rgba(40,167,69,0.8)','rgba(220,53,69,0.85)','rgba(108,117,125,0.6)'],
                    borderColor: ['rgba(40,167,69,1)','rgba(220,53,69,1)','rgba(108,117,125,1)'],
                    borderWidth: 1
                }]
            },
            options: Object.assign({
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }, datalabelsPctOptions(totalVenc, '#fff')),
            plugins: [ChartDataLabels]
        });
    }

    // BAR chart por estado (con % encima)
    if (estados.length && cantidades.length) {
        new Chart(document.getElementById('chartBar'), {
            type: 'bar',
            data: { labels: estados, datasets: [{ label: 'Cantidad', data: cantidades, backgroundColor: colores }] },
            options: Object.assign({
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, precision:0 } }
            }, datalabelsPctOptions(totalEstados, '#000')),
            plugins: [ChartDataLabels]
        });
    }

    // LINE chart por estado (simple)
    if (estados.length && cantidades.length) {
        new Chart(document.getElementById('chartLine'), {
            type: 'line',
            data: { labels: estados, datasets: [{ label: 'Evoluci칩n', data: cantidades, borderColor: 'rgba(13,110,253,0.9)', tension: 0.25, fill: false }] },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });
    }

    // Exportar todas las gr치ficas como imagen
    document.getElementById('exportarImagen').addEventListener('click', function() {
        // tomamos el contenedor con todas las gr치ficas
        const contenedor = document.querySelector('.row.g-4') || document.body;
        html2canvas(contenedor).then(canvas => {
            const link = document.createElement('a');
            link.download = 'graficas_reuniones.png';
            link.href = canvas.toDataURL();
            link.click();
        }).catch(err => console.error(err));
    });
});
</script>
{% endblock %}
